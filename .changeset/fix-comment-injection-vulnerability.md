---
"@ts-graphviz/ast": patch
---

Fix comment injection vulnerability in block comments

Addresses security vulnerability where malicious `*/` sequences in comment content could break out of block comment context and inject arbitrary DOT syntax.

## Security Enhancement

### Comment Content Escaping
- Added `escapeComment()` utility function to sanitize comment content
- Block comments: Breaks up `*/` sequences using zero-width space (U+200B) to prevent early comment termination
- All comment types: Removes null bytes that could cause parsing issues
- Follows C/C++ and DOT language specifications where block comments cannot be nested

## Changes

### New Utility Function
- `escapeComment()` in `packages/ast/src/dot-shim/printer/plugins/utils/escape-comment.ts`
- Prevents comment injection by inserting zero-width space between `*` and `/`
- Maintains visual appearance while preventing syntax injection
- Verified to work with Graphviz 13.1.1

### Updated Components
- `CommentPrintPlugin` now applies escaping before outputting comment content
- All comment values are sanitized at print time, not at creation time
- Maintains backward compatibility with existing AST structures

### Testing
- 11 unit tests for `escapeComment()` function covering:
  - Block comment injection prevention
  - Multiple `*/` sequence handling
  - Null byte removal
  - Normal content preservation
- Integration tests in `stringify.test.ts` for end-to-end verification
- All existing tests continue to pass

## Security Impact

- Prevents DOT syntax injection via malicious comment content
- Blocks attempts to escape comment context and inject arbitrary graph definitions
- Protects against parser manipulation through crafted comment values
- Zero-width space approach is standards-compliant and validated with official Graphviz parser

## Technical Details

According to C/C++ and DOT language specifications, block comments (`/* */`) cannot be nested and there is no escape sequence for the closing delimiter within comments. The standard workaround is to insert a zero-width space (U+200B) between `*` and `/`, which:
- Prevents early comment termination
- Preserves visual appearance (zero-width character is invisible)
- Is correctly handled by Graphviz parser (tested with version 13.1.1)
- Follows industry best practices for comment sanitization
